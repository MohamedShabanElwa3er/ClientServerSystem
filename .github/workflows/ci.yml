name: Qt6 CI

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    env:
      QT_QPA_PLATFORM: offscreen
      QT_LOGGING_RULES: "qt.qpa.*=false"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qt, build tools, and coverage tools
        run: |
          sudo apt update
          sudo apt install -y \
            qt6-base-dev \
            qt6-tools-dev \
            qt6-tools-dev-tools \
            build-essential \
            cmake \
            libgtest-dev \
            lcov \
            gcovr \
            jq \
            bc

      - name: Build GoogleTest
        run: |
          cd /usr/src/gtest
          sudo cmake .
          sudo make -j$(nproc)
          sudo cp lib/*.a /usr/lib

      - name: Clean build artifacts
        run: |
          find . -name Makefile -delete
          find . -name "*.o" -delete
          find . -name "moc_*.cpp" -delete
          rm -f .qmake.stash

      - name: Verify test sources exist
        run: |
          echo "Checking GoogleTest sources..."
          for pro in tests/gtest/*/*.pro; do
            dir=$(dirname "$pro")
            grep -o '[^ ]*\.cpp' "$pro" | while read src; do
              test -f "$dir/$src" || { echo "Missing $dir/$src"; exit 1; }
            done
          done

      - name: Configure project with coverage
        run: |
          qmake6 -r ClientServerSystem.pro \
            "QMAKE_CXXFLAGS+=--coverage -O0" \
            "QMAKE_LFLAGS+=--coverage"

      - name: Build project
        run: make -j$(nproc)

      - name: Run GoogleTests with XML output
        run: |
          echo "Running GoogleTest..."
          mkdir -p test_results
          ./tests/gtest/test_commands/test_commands --gtest_output=xml:test_results/results.xml 2>&1 | tee test_output.txt || true
          cat test_output.txt

      - name: Parse test results
        run: |
          if [ -f test_results/results.xml ]; then
            echo "Parsing XML results..."
            GTEST_TOTAL=$(grep -oP 'tests="\K[0-9]+' test_results/results.xml | head -1 || echo "0")
            GTEST_FAILURES=$(grep -oP 'failures="\K[0-9]+' test_results/results.xml | head -1 || echo "0")
            GTEST_ERRORS=$(grep -oP 'errors="\K[0-9]+' test_results/results.xml | head -1 || echo "0")
            GTEST_FAILED=$((GTEST_FAILURES + GTEST_ERRORS))
            GTEST_PASSED=$((GTEST_TOTAL - GTEST_FAILED))
          else
            GTEST_PASSED=$(grep "PASSED" test_output.txt | grep -oE '[0-9]+' | tail -1 || echo "0")
            GTEST_FAILED=$(grep "FAILED" test_output.txt | grep -oE '[0-9]+' | tail -1 || echo "0")
            GTEST_PASSED=${GTEST_PASSED:-0}
            GTEST_FAILED=${GTEST_FAILED:-0}
            GTEST_TOTAL=$((GTEST_PASSED + GTEST_FAILED))
          fi
          echo "GTEST_PASSED=$GTEST_PASSED" >> "$GITHUB_ENV"
          echo "GTEST_FAILED=$GTEST_FAILED" >> "$GITHUB_ENV"
          echo "GTEST_TOTAL=$GTEST_TOTAL" >> "$GITHUB_ENV"
          echo "GoogleTest Results: $GTEST_PASSED passed, $GTEST_FAILED failed out of $GTEST_TOTAL tests"

      - name: Capture coverage data
        run: |
          lcov --capture \
               --directory . \
               --ignore-errors mismatch,empty \
               --rc geninfo_unexecuted_blocks=1 \
               --output-file coverage_raw.info
          lcov --remove coverage_raw.info \
               '/usr/*' \
               '*/tests/*' \
               --output-file coverage.info
          echo "=== LCOV Summary ==="
          lcov --summary coverage.info 2>&1 | tee lcov_summary.txt
          LINE_PERCENT=$(grep 'lines' lcov_summary.txt | grep -oE '[0-9]+\.[0-9]+' | head -1)
          FUNC_PERCENT=$(grep 'functions' lcov_summary.txt | grep -oE '[0-9]+\.[0-9]+' | head -1)
          LINE_INFO=$(grep 'lines' lcov_summary.txt)
          FUNC_INFO=$(grep 'functions' lcov_summary.txt)
          LINES_COVERED=$(echo "$LINE_INFO" | grep -oE '\([0-9]+' | tr -d '(')
          LINES_TOTAL=$(echo "$LINE_INFO" | grep -oE 'of [0-9]+' | grep -oE '[0-9]+')
          FUNCS_COVERED=$(echo "$FUNC_INFO" | grep -oE '\([0-9]+' | tr -d '(')
          FUNCS_TOTAL=$(echo "$FUNC_INFO" | grep -oE 'of [0-9]+' | grep -oE '[0-9]+')
          LINE_PERCENT=${LINE_PERCENT:-0}
          FUNC_PERCENT=${FUNC_PERCENT:-0}
          LINES_COVERED=${LINES_COVERED:-0}
          LINES_TOTAL=${LINES_TOTAL:-0}
          FUNCS_COVERED=${FUNCS_COVERED:-0}
          FUNCS_TOTAL=${FUNCS_TOTAL:-0}
          echo "LINE_PERCENT=$LINE_PERCENT" >> "$GITHUB_ENV"
          echo "FUNC_PERCENT=$FUNC_PERCENT" >> "$GITHUB_ENV"
          echo "LINES_COVERED=$LINES_COVERED" >> "$GITHUB_ENV"
          echo "LINES_TOTAL=$LINES_TOTAL" >> "$GITHUB_ENV"
          echo "FUNCS_COVERED=$FUNCS_COVERED" >> "$GITHUB_ENV"
          echo "FUNCS_TOTAL=$FUNCS_TOTAL" >> "$GITHUB_ENV"
          echo "Coverage Results: Line=${LINE_PERCENT}% Function=${FUNC_PERCENT}%"

      - name: Generate HTML coverage report
        run: |
          genhtml coverage.info \
            --output-directory coverage_html \
            --title "ClientServerSystem Coverage" \
            --legend

      - name: Generate unified HTML report
        run: python3 .github/scripts/generate_report.py

      - name: Create deliverable ZIP
        run: |
          zip -r ClientServerSystem_Deliverable.zip REPORT.html coverage_html/ test_results/

      - name: Upload deliverable
        uses: actions/upload-artifact@v4
        with:
          name: ClientServerSystem_Deliverable
          path: ClientServerSystem_Deliverable.zip