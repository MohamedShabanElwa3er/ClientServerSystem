name: Qt6 CI

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    env:
      QT_QPA_PLATFORM: offscreen
      QT_LOGGING_RULES: "qt.qpa.*=false"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qt, build tools, and coverage tools
        run: |
          sudo apt update
          sudo apt install -y \
            qt6-base-dev \
            qt6-tools-dev \
            qt6-tools-dev-tools \
            build-essential \
            cmake \
            libgtest-dev \
            lcov \
            gcovr \
            jq \
            bc

      - name: Build GoogleTest
        run: |
          cd /usr/src/gtest
          sudo cmake .
          sudo make -j$(nproc)
          sudo cp lib/*.a /usr/lib

      - name: Clean build artifacts
        run: |
          find . -name Makefile -delete
          find . -name "*.o" -delete
          find . -name "moc_*.cpp" -delete
          rm -f .qmake.stash

      - name: Verify test sources exist
        run: |
          echo "Checking GoogleTest sources..."
          for pro in tests/gtest/*/*.pro; do
            dir=$(dirname "$pro")
            grep -o '[^ ]*\.cpp' "$pro" | while read src; do
              test -f "$dir/$src" || { echo "Missing $dir/$src"; exit 1; }
            done
          done

      - name: Configure project (with coverage)
        run: |
          qmake6 -r ClientServerSystem.pro \
            "QMAKE_CXXFLAGS+=--coverage -O0" \
            "QMAKE_LFLAGS+=--coverage"

      - name: Build project
        run: make -j$(nproc)

      # ============================================================
      # ✅ GENERIC GOOGLE TEST RUNNER
      # ============================================================
      - name: Run GoogleTests (generic)
        id: gtest
        shell: bash
        run: |
          echo "Discovering GoogleTest executables..."

          TOTAL_PASSED=0
          TOTAL_FAILED=0
          FAILED_BINARIES=0

          mapfile -t TEST_BINS < <(
            find tests/gtest -type f -executable ! -name "*.so" ! -name "*.a"
          )

          if [ ${#TEST_BINS[@]} -eq 0 ]; then
            echo "❌ No GoogleTest executables found!"
            exit 1
          fi

          echo "✅ Found ${#TEST_BINS[@]} test binaries"

          for BIN in "${TEST_BINS[@]}"; do
            echo "----------------------------------------"
            echo "▶ Running: $BIN"

            OUTPUT=$("$BIN" 2>&1)
            EXIT_CODE=$?

            echo "$OUTPUT"

            PASSED=$(echo "$OUTPUT" | grep -Eo '[0-9]+ tests? passed' | grep -Eo '[0-9]+' | tail -1)
            FAILED=$(echo "$OUTPUT" | grep -Eo '[0-9]+ tests? failed' | grep -Eo '[0-9]+' | tail -1)

            PASSED=${PASSED:-0}
            FAILED=${FAILED:-0}

            TOTAL_PASSED=$((TOTAL_PASSED + PASSED))
            TOTAL_FAILED=$((TOTAL_FAILED + FAILED))

            if [ "$EXIT_CODE" -ne 0 ]; then
              FAILED_BINARIES=$((FAILED_BINARIES + 1))
            fi
          done

          echo "========================================"
          echo "✅ GoogleTest Summary:"
          echo "   Passed: $TOTAL_PASSED"
          echo "   Failed: $TOTAL_FAILED"
          echo "   Failed binaries: $FAILED_BINARIES"

          echo "GTEST_PASSED=$TOTAL_PASSED" >> "$GITHUB_ENV"
          echo "GTEST_FAILED=$TOTAL_FAILED" >> "$GITHUB_ENV"

          if [ "$TOTAL_FAILED" -ne 0 ]; then
            echo "❌ Some GoogleTests failed"
            exit 1
          fi

      # ============================================================
      # COVERAGE
      # ============================================================
      - name: Capture coverage data
        run: |
          lcov --capture \
               --directory . \
               --ignore-errors mismatch,empty \
               --rc geninfo_unexecuted_blocks=1 \
               --output-file coverage_raw.info

          lcov --remove coverage_raw.info \
               '/usr/*' \
               '*/tests/*' \
               --output-file coverage.info

          echo "=== LCOV Summary ==="
          lcov --summary coverage.info 2>&1 | tee lcov_summary.txt
          
          LINE_PERCENT=$(grep 'lines' lcov_summary.txt | grep -oE '[0-9]+\.[0-9]+' | head -1)
          FUNC_PERCENT=$(grep 'functions' lcov_summary.txt | grep -oE '[0-9]+\.[0-9]+' | head -1)
          
          LINE_INFO=$(grep 'lines' lcov_summary.txt)
          FUNC_INFO=$(grep 'functions' lcov_summary.txt)
          
          LINES_COVERED=$(echo "$LINE_INFO" | grep -oE '\([0-9]+' | tr -d '(')
          LINES_TOTAL=$(echo "$LINE_INFO" | grep -oE 'of [0-9]+' | grep -oE '[0-9]+')
          
          FUNCS_COVERED=$(echo "$FUNC_INFO" | grep -oE '\([0-9]+' | tr -d '(')
          FUNCS_TOTAL=$(echo "$FUNC_INFO" | grep -oE 'of [0-9]+' | grep -oE '[0-9]+')
          
          LINE_PERCENT=${LINE_PERCENT:-0}
          FUNC_PERCENT=${FUNC_PERCENT:-0}
          LINES_COVERED=${LINES_COVERED:-0}
          LINES_TOTAL=${LINES_TOTAL:-0}
          FUNCS_COVERED=${FUNCS_COVERED:-0}
          FUNCS_TOTAL=${FUNCS_TOTAL:-0}
          
          echo "LINE_PERCENT=$LINE_PERCENT" >> "$GITHUB_ENV"
          echo "FUNC_PERCENT=$FUNC_PERCENT" >> "$GITHUB_ENV"
          echo "LINES_COVERED=$LINES_COVERED" >> "$GITHUB_ENV"
          echo "LINES_TOTAL=$LINES_TOTAL" >> "$GITHUB_ENV"
          echo "FUNCS_COVERED=$FUNCS_COVERED" >> "$GITHUB_ENV"
          echo "FUNCS_TOTAL=$FUNCS_TOTAL" >> "$GITHUB_ENV"

      - name: Generate HTML coverage report
        run: |
          genhtml coverage.info \
            --output-directory coverage_html \
            --title "ClientServerSystem Coverage" \
            --legend

      # ============================================================
      # DELIVERABLE
      # ============================================================
      - name: Create deliverable ZIP
        run: zip -r ClientServerSystem_Deliverable.zip REPORT.html coverage_html/ || true

      - name: Upload deliverable
        uses: actions/upload-artifact@v4
        with:
          name: ClientServerSystem_Deliverable
          path: ClientServerSystem_Deliverable.zip