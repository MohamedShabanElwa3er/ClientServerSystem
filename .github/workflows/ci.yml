name: Qt6 CI

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    # ‚úÖ Global environment (headless Qt)
    env:
      QT_QPA_PLATFORM: offscreen
      QT_LOGGING_RULES: "qt.qpa.*=false"

    steps:
    # =========================
    # 1Ô∏è‚É£ Checkout repository
    # =========================
    - name: Checkout code
      uses: actions/checkout@v4

    # =========================
    # 2Ô∏è‚É£ Install dependencies
    # =========================
    - name: Install Qt, build tools, and coverage tools
      run: |
        sudo apt update
        sudo apt install -y \
          qt6-base-dev \
          qt6-tools-dev \
          qt6-tools-dev-tools \
          build-essential \
          cmake \
          libgtest-dev \
          lcov \
          gcovr

    # =========================
    # 3Ô∏è‚É£ Build GoogleTest
    # =========================
    - name: Build GoogleTest
      run: |
        cd /usr/src/gtest
        sudo cmake .
        sudo make -j$(nproc)
        sudo cp lib/*.a /usr/lib

    # =========================
    # 4Ô∏è‚É£ Clean build artifacts
    # =========================
    - name: Clean build artifacts
      run: |
        find . -name Makefile -delete
        find . -name "*.o" -delete
        find . -name "moc_*.cpp" -delete
        rm -f .qmake.stash

    # =========================
    # 5Ô∏è‚É£ Preflight checks
    # =========================
    - name: Verify test sources exist
      run: |
        echo "üîç Checking Qt tests..."
        for d in tests/qt/test_*; do
          name=$(basename "$d")
          test -f "$d/$name.cpp" || { echo "‚ùå Missing $d/$name.cpp"; exit 1; }
        done

        echo "üîç Checking GoogleTest sources..."
        for pro in tests/gtest/*/*.pro; do
          dir=$(dirname "$pro")
          grep -o '[^ ]*\.cpp' "$pro" | while read src; do
            test -f "$dir/$src" || { echo "‚ùå Missing $dir/$src"; exit 1; }
          done
        done

    # =========================
    # 6Ô∏è‚É£ Configure project (qmake + coverage)
    # =========================
    - name: Configure project (with coverage)
      run: |
        qmake6 -r ClientServerSystem.pro \
          "QMAKE_CXXFLAGS+=--coverage -O0" \
          "QMAKE_LFLAGS+=--coverage"

    # =========================
    # 7Ô∏è‚É£ Build project
    # =========================
    - name: Build project
      run: |
        make -j$(nproc)

    # =========================
    # 8Ô∏è‚É£ Run QtTests
    # =========================
    - name: Run QtTests
      run: |
        ./tests/qt/test_parser/test_parser
        ./tests/qt/test_append/test_append
        ./tests/qt/test_info/test_info
        ./tests/qt/test_cpu/test_cpu

    # =========================
    # 9Ô∏è‚É£ Run GoogleTests
    # =========================
    - name: Run GoogleTests
      run: |
        ./tests/gtest/test_commands/test_commands

    # =========================
    # üîü Collect coverage data (lcov)
    # =========================
    - name: Capture coverage data
      run: |
        lcov --capture \
             --directory . \
             --ignore-errors mismatch,empty \
             --rc geninfo_unexecuted_blocks=1 \
             --output-file coverage.info

        lcov --remove coverage.info \
             '/usr/*' \
             '*/tests/*' \
             --output-file coverage.info

    # =========================
    # 1Ô∏è‚É£1Ô∏è‚É£ Generate professional coverage HTML (gcovr)
    # =========================
    - name: Generate coverage HTML report
      run: |
        gcovr \
          --root . \
          --filter common \
          --filter server \
          --html-details \
          --html-title "ClientServerSystem Coverage Report" \
          --output coverage.html

    # =========================
    # 1Ô∏è‚É£2Ô∏è‚É£ Generate HTML project report
    # =========================
    - name: Generate HTML project report
      run: |
        cat << EOF > PROJECT_REPORT.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <title>ClientServerSystem ‚Äì CI, Testing & Coverage</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 40px; background:#f9f9f9; }
            h1, h2, h3 { color:#2c3e50; }
            .section { background:#fff; padding:20px; margin-bottom:20px; border-radius:6px; box-shadow:0 0 6px rgba(0,0,0,.1); }
            iframe { width:100%; height:900px; border:1px solid #ccc; }
            table { width:100%; border-collapse:collapse; }
            th, td { border:1px solid #ccc; padding:10px; }
          </style>
        </head>
        <body>

        <h1>‚úÖ ClientServerSystem</h1>
        <h2>CI, Testing & Coverage Report</h2>

        <div class="section">
          <h3>üë§ Author</h3>
          <p><strong>Name:</strong> Mohamed Waaer</p>
          <p><strong>Email:</strong> mohamed.waer@coretech-innovations.com</p>
        </div>

        <div class="section">
          <h3>üìå Project Overview</h3>
          <p>
            ClientServerSystem is a modular client‚Äìserver application developed in
            C++ (C++17) using the Qt 6 framework. The project demonstrates a clean
            separation between client, server, and shared logic, with a strong focus
            on testability, automation, and software quality.
          </p>
          <p>
            The system integrates automated unit testing using QtTest and GoogleTest,
            combined with continuous integration and coverage analysis to ensure
            correctness, maintainability, and long-term scalability.
          </p>
        </div>

        <div class="section">
          <h3>üîÅ CI Summary</h3>
          <table>
            <tr><th>Platform</th><td>GitHub Actions</td></tr>
            <tr><th>OS</th><td>Ubuntu</td></tr>
            <tr><th>Commit</th><td>$GITHUB_SHA</td></tr>
            <tr><th>Date</th><td>$(date)</td></tr>
          </table>
        </div>

        <div class="section">
          <h3>üß™ Testing</h3>
          <ul>
            <li>QtTest ‚Äì Core and Qt-dependent logic</li>
            <li>GoogleTest ‚Äì Server command validation</li>
          </ul>
        </div>

        <div class="section">
          <h3>üìä Test Coverage</h3>
          <p>
            The coverage report below is generated using <strong>gcov + gcovr</strong>,
            providing a reliable, self-contained HTML report with execution statistics
            and coverage charts for production code.
          </p>
          <iframe src="./coverage.html"></iframe>
        </div>

        <p style="color:#777; font-size:.9em;">
          Generated automatically by GitHub Actions CI
        </p>

        </body>
        </html>
        EOF

    # =========================
    # 1Ô∏è‚É£3Ô∏è‚É£ Create deliverable ZIP
    # =========================
    - name: Create deliverable ZIP
      run: |
        zip -r ClientServerSystem_Deliverable.zip \
          PROJECT_REPORT.html \
          coverage.html

    # =========================
    # 1Ô∏è‚É£4Ô∏è‚É£ Upload artifacts
    # =========================
    - name: Upload deliverable
      uses: actions/upload-artifact@v4
      with:
        name: ClientServerSystem_Deliverable
        path: ClientServerSystem_Deliverable.zip