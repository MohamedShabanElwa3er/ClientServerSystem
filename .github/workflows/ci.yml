name: Qt6 CI

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    # ‚úÖ Global environment (headless Qt)
    env:
      QT_QPA_PLATFORM: offscreen
      QT_LOGGING_RULES: "qt.qpa.*=false"

    steps:
    # =========================
    # 1Ô∏è‚É£ Checkout repository
    # =========================
    - name: Checkout code
      uses: actions/checkout@v4

    # =========================
    # 2Ô∏è‚É£ Install dependencies
    # =========================
    - name: Install Qt, build tools, and coverage tools
      run: |
        sudo apt update
        sudo apt install -y \
          qt6-base-dev \
          qt6-tools-dev \
          qt6-tools-dev-tools \
          build-essential \
          cmake \
          libgtest-dev \
          lcov \
          gcovr \
          jq

    # =========================
    # 3Ô∏è‚É£ Build GoogleTest
    # =========================
    - name: Build GoogleTest
      run: |
        cd /usr/src/gtest
        sudo cmake .
        sudo make -j$(nproc)
        sudo cp lib/*.a /usr/lib

    # =========================
    # 4Ô∏è‚É£ Clean build artifacts
    # =========================
    - name: Clean build artifacts
      run: |
        find . -name Makefile -delete
        find . -name "*.o" -delete
        find . -name "moc_*.cpp" -delete
        rm -f .qmake.stash

    # =========================
    # 5Ô∏è‚É£ Preflight checks
    # =========================
    - name: Verify test sources exist
      run: |
        echo "üîç Checking Qt tests..."
        for d in tests/qt/test_*; do
          name=$(basename "$d")
          test -f "$d/$name.cpp" || { echo "‚ùå Missing $d/$name.cpp"; exit 1; }
        done

        echo "üîç Checking GoogleTest sources..."
        for pro in tests/gtest/*/*.pro; do
          dir=$(dirname "$pro")
          grep -o '[^ ]*\.cpp' "$pro" | while read src; do
            test -f "$dir/$src" || { echo "‚ùå Missing $dir/$src"; exit 1; }
          done
        done

    # =========================
    # 6Ô∏è‚É£ Configure project (qmake + coverage)
    # =========================
    - name: Configure project (with coverage)
      run: |
        qmake6 -r ClientServerSystem.pro \
          "QMAKE_CXXFLAGS+=--coverage -O0" \
          "QMAKE_LFLAGS+=--coverage"

    # =========================
    # 7Ô∏è‚É£ Build project
    # =========================
    - name: Build project
      run: |
        make -j$(nproc)

    # =========================
    # 8Ô∏è‚É£ Run QtTests
    # =========================
    - name: Run QtTests
      run: |
        ./tests/qt/test_parser/test_parser
        ./tests/qt/test_append/test_append
        ./tests/qt/test_info/test_info
        ./tests/qt/test_cpu/test_cpu

    # =========================
    # 9Ô∏è‚É£ Run GoogleTests
    # =========================
    - name: Run GoogleTests
      run: |
        ./tests/gtest/test_commands/test_commands

    # =========================
    # üîü Capture coverage data (lcov)
    # =========================
    - name: Capture coverage data
      run: |
        lcov --capture \
             --directory . \
             --ignore-errors mismatch,empty \
             --rc geninfo_unexecuted_blocks=1 \
             --output-file coverage.info

        lcov --remove coverage.info \
             '/usr/*' \
             '*/tests/*' \
             --output-file coverage.info

    # =========================
    # 1Ô∏è‚É£1Ô∏è‚É£ Generate coverage JSON (FIXED)
    # =========================
    - name: Generate coverage JSON
      run: |
        gcovr \
          --root . \
          --filter '.*\/common\/.*' \
          --filter '.*\/server\/.*' \
          --exclude '.*\/tests\/.*' \
          --json-summary coverage_summary.json \
          --json coverage.json
        
        # Debug: Print the JSON structure to understand it
        echo "=== Coverage Summary JSON ==="
        cat coverage_summary.json
        echo ""
        echo "=== Coverage JSON (first 100 lines) ==="
        head -100 coverage.json

    # =========================
    # 1Ô∏è‚É£2Ô∏è‚É£ Generate unified HTML report with plots
    # =========================
    - name: Generate unified HTML report
      run: |
        # Extract line coverage percentage from gcovr summary JSON
        # gcovr --json-summary format has: line_percent, branch_percent, etc.
        LINE_PERCENT=$(jq '.line_percent // .line_coverage // 0' coverage_summary.json 2>/dev/null || echo "0")
        BRANCH_PERCENT=$(jq '.branch_percent // .branch_coverage // 0' coverage_summary.json 2>/dev/null || echo "0")
        
        # If still 0, try alternative extraction from the detailed coverage.json
        if [ "$LINE_PERCENT" = "0" ] || [ "$LINE_PERCENT" = "null" ]; then
          # Calculate from coverage.json if summary didn't work
          LINES_COVERED=$(jq '[.files[].lines_covered] | add // 0' coverage.json 2>/dev/null || echo "0")
          LINES_TOTAL=$(jq '[.files[].lines_total] | add // 0' coverage.json 2>/dev/null || echo "0")
          
          if [ "$LINES_TOTAL" != "0" ] && [ "$LINES_TOTAL" != "null" ]; then
            LINE_PERCENT=$(echo "scale=2; $LINES_COVERED * 100 / $LINES_TOTAL" | bc)
          else
            LINE_PERCENT=0
          fi
        fi
        
        # Remove quotes if present
        LINE_PERCENT=$(echo "$LINE_PERCENT" | tr -d '"')
        BRANCH_PERCENT=$(echo "$BRANCH_PERCENT" | tr -d '"')
        
        # Ensure we have valid numbers
        if [ -z "$LINE_PERCENT" ] || [ "$LINE_PERCENT" = "null" ]; then
          LINE_PERCENT=0
        fi
        if [ -z "$BRANCH_PERCENT" ] || [ "$BRANCH_PERCENT" = "null" ]; then
          BRANCH_PERCENT=0
        fi
        
        # Calculate not covered percentage
        NOT_COVERED=$(echo "scale=2; 100 - $LINE_PERCENT" | bc)
        
        echo "üìä Coverage Results:"
        echo "   Line Coverage: ${LINE_PERCENT}%"
        echo "   Branch Coverage: ${BRANCH_PERCENT}%"
        echo "   Not Covered: ${NOT_COVERED}%"

        cat << EOF > REPORT.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <title>ClientServerSystem ‚Äì CI & Coverage Report</title>
          <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
          <style>
            body { font-family: Arial, sans-serif; background:#f9f9f9; margin:40px; }
            h1, h2, h3 { color:#2c3e50; }
            .section { background:#fff; padding:20px; margin-bottom:25px; border-radius:6px; box-shadow:0 0 6px rgba(0,0,0,.1); }
            .grid { display:grid; grid-template-columns:1fr 1fr; gap:30px; }
            canvas { max-width:100%; }
            .footer { color:#777; font-size:.9em; }
            .metrics { font-size: 1.2em; margin-bottom: 20px; }
            .metrics span { font-weight: bold; color: #4DD0E1; }
            .metrics .low { color: #FF9F40; }
            .metrics .medium { color: #FFCD56; }
            .metrics .high { color: #4BC0C0; }
          </style>
        </head>

        <body>

        <h1>‚úÖ ClientServerSystem</h1>
        <h2>CI, Testing & Coverage Report</h2>

        <div class="section">
          <h3>üë§ Author</h3>
          <p><strong>Name:</strong> Mohamed Waaer</p>
          <p><strong>Email:</strong> mohamed.waer@coretech-innovations.com</p>
        </div>

        <div class="section">
          <h3>üìä Test Coverage Metrics</h3>
          <div class="metrics">
            <p>Line Coverage: <span class="${LINE_PERCENT%.*}" id="line-cov">${LINE_PERCENT}%</span></p>
            <p>Branch Coverage: <span id="branch-cov">${BRANCH_PERCENT}%</span></p>
          </div>
          <div class="grid">
            <div>
              <h4 style="text-align:center;">Test Coverage Metric</h4>
              <canvas id="coveragePie"></canvas>
            </div>
            <div>
              <h4 style="text-align:center;">Test Result Details</h4>
              <canvas id="coverageBar"></canvas>
            </div>
          </div>
        </div>

        <script>
          const lineCoverage = ${LINE_PERCENT};
          const branchCoverage = ${BRANCH_PERCENT};
          const notCovered = ${NOT_COVERED};
          
          new Chart(document.getElementById('coveragePie'), {
            type: 'pie',
            data: {
              labels: ['Covered Code (' + lineCoverage.toFixed(1) + '%)', 'Not Covered (' + notCovered.toFixed(1) + '%)'],
              datasets: [{
                data: [lineCoverage, notCovered],
                backgroundColor: ['#4DD0E1', '#FF9F40']
              }]
            },
            options: {
              plugins: {
                legend: {
                  position: 'top'
                },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return context.label + ': ' + context.parsed.toFixed(2) + '%';
                    }
                  }
                }
              }
            }
          });

          new Chart(document.getElementById('coverageBar'), {
            type: 'bar',
            data: {
              labels: ['Line Coverage', 'Branch Coverage'],
              datasets: [{
                label: 'Coverage (%)',
                data: [lineCoverage, branchCoverage],
                backgroundColor: ['#4DD0E1', '#3A4A62']
              }]
            },
            options: {
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return 'Coverage: ' + context.parsed.y.toFixed(2) + '%';
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100,
                  ticks: {
                    callback: function(value) {
                      return value + '%';
                    }
                  }
                }
              }
            }
          });
        </script>

        <div class="footer">
          Generated automatically by GitHub Actions CI on $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        </div>

        </body>
        </html>
        EOF

    # =========================
    # 1Ô∏è‚É£3Ô∏è‚É£ Create deliverable ZIP
    # =========================
    - name: Create deliverable ZIP
      run: |
        zip -r ClientServerSystem_Deliverable.zip REPORT.html coverage_summary.json

    # =========================
    # 1Ô∏è‚É£4Ô∏è‚É£ Upload artifacts
    # =========================
    - name: Upload deliverable
      uses: actions/upload-artifact@v4
      with:
        name: ClientServerSystem_Deliverable
        path: ClientServerSystem_Deliverable.zip