name: Qt6 CI

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    env:
      QT_QPA_PLATFORM: offscreen
      QT_LOGGING_RULES: "qt.qpa.*=false"

    steps:
    # =========================
    # 1Ô∏è‚É£ Checkout repository
    # =========================
    - name: Checkout code
      uses: actions/checkout@v4

    # =========================
    # 2Ô∏è‚É£ Install dependencies
    # =========================
    - name: Install Qt, build tools, and coverage tools
      run: |
        sudo apt update
        sudo apt install -y \
          qt6-base-dev \
          qt6-tools-dev \
          qt6-tools-dev-tools \
          build-essential \
          cmake \
          libgtest-dev \
          lcov \
          gcovr \
          jq

    # =========================
    # 3Ô∏è‚É£ Build GoogleTest
    # =========================
    - name: Build GoogleTest
      run: |
        cd /usr/src/gtest
        sudo cmake .
        sudo make -j$(nproc)
        sudo cp lib/*.a /usr/lib

    # =========================
    # 4Ô∏è‚É£ Clean build artifacts
    # =========================
    - name: Clean build artifacts
      run: |
        find . -name Makefile -delete
        find . -name "*.o" -delete
        find . -name "moc_*.cpp" -delete
        rm -f .qmake.stash

    # =========================
    # 5Ô∏è‚É£ Configure project (qmake + coverage)
    # =========================
    - name: Configure project (with coverage)
      run: |
        qmake6 -r ClientServerSystem.pro \
          "QMAKE_CXXFLAGS+=--coverage -O0" \
          "QMAKE_LFLAGS+=--coverage"

    # =========================
    # 6Ô∏è‚É£ Build project
    # =========================
    - name: Build project
      run: |
        make -j$(nproc)

    # =========================
    # 7Ô∏è‚É£ Run tests
    # =========================
    - name: Run QtTests
      run: |
        ./tests/qt/test_parser/test_parser
        ./tests/qt/test_append/test_append
        ./tests/qt/test_info/test_info
        ./tests/qt/test_cpu/test_cpu

    - name: Run GoogleTests
      run: |
        ./tests/gtest/test_commands/test_commands

    # =========================
    # 8Ô∏è‚É£ Capture coverage
    # =========================
    - name: Capture coverage
      run: |
        lcov --capture \
             --directory . \
             --ignore-errors mismatch,empty \
             --rc geninfo_unexecuted_blocks=1 \
             --output-file coverage.info

        lcov --remove coverage.info \
             '/usr/*' \
             '*/tests/*' \
             --output-file coverage.info

    # =========================
    # 9Ô∏è‚É£ Generate coverage JSON
    # =========================
    - name: Generate coverage JSON
      run: |
        gcovr --root . --exclude tests --json coverage.json

    # =========================
    # üîü Generate FINAL HTML report with NUMBERS
    # =========================
    - name: Generate REPORT.html
      run: |
        COVERED=$(jq '.line_coverage.covered' coverage.json)
        TOTAL=$(jq '.line_coverage.total' coverage.json)
        MISSED=$(jq '.line_coverage.missed' coverage.json)
        PERCENT=$(jq '.line_coverage.percent // .line_coverage.percentage' coverage.json)

        cat << EOF > REPORT.html
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <title>ClientServerSystem ‚Äì CI & Coverage Report</title>

          <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
          <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

          <style>
            body { font-family: Arial, sans-serif; background:#f9f9f9; margin:40px; }
            h1, h2, h3 { color:#2c3e50; }
            .section { background:#fff; padding:20px; margin-bottom:25px;
                       border-radius:6px; box-shadow:0 0 6px rgba(0,0,0,.1); }
            .grid { display:grid; grid-template-columns:1fr 1fr; gap:30px; }
            canvas { max-width:100%; }
          </style>
        </head>

        <body>

        <h1>‚úÖ ClientServerSystem</h1>
        <h2>CI, Testing & Coverage Report</h2>

        <div class="section">
          <h3>üìä Test Coverage Metric</h3>
          <div class="grid">
            <canvas id="coveragePie"></canvas>
            <canvas id="coverageBar"></canvas>
          </div>
        </div>

        <script>
          Chart.register(ChartDataLabels);

          new Chart(document.getElementById('coveragePie'), {
            type: 'pie',
            data: {
              labels: ['Covered', 'Not Covered'],
              datasets: [{
                data: [$COVERED, $MISSED],
                backgroundColor: ['#4DD0E1', '#FF9F40']
              }]
            },
            options: {
              plugins: {
                title: {
                  display: true,
                  text: 'Test Coverage Metric'
                },
                datalabels: {
                  color: '#fff',
                  formatter: (value) => value
                }
              }
            }
          });

          new Chart(document.getElementById('coverageBar'), {
            type: 'bar',
            data: {
              labels: ['Total Lines', 'Covered Lines'],
              datasets: [{
                label: 'Lines',
                data: [$TOTAL, $COVERED],
                backgroundColor: ['#3A4A62', '#4DD0E1']
              }]
            },
            options: {
              plugins: {
                title: {
                  display: true,
                  text: 'Coverage Details'
                },
                datalabels: {
                  anchor: 'end',
                  align: 'top',
                  formatter: (value) => value
                }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        </script>

        </body>
        </html>
        EOF

    # =========================
    # 1Ô∏è‚É£1Ô∏è‚É£ Package artifact
    # =========================
    - name: Upload report
      uses: actions/upload-artifact@v4
      with:
        name: ClientServerSystem_Report
        path: REPORT.html