name: Qt6 CI

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    env:
      QT_QPA_PLATFORM: offscreen
      QT_LOGGING_RULES: "qt.qpa.*=false"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qt, build tools, and coverage tools
        run: |
          sudo apt update
          sudo apt install -y \
            qt6-base-dev \
            qt6-tools-dev \
            qt6-tools-dev-tools \
            build-essential \
            cmake \
            libgtest-dev \
            lcov \
            gcovr \
            jq \
            bc

      - name: Build GoogleTest
        run: |
          cd /usr/src/gtest
          sudo cmake .
          sudo make -j$(nproc)
          sudo cp lib/*.a /usr/lib

      - name: Clean build artifacts
        run: |
          find . -name Makefile -delete
          find . -name "*.o" -delete
          find . -name "moc_*.cpp" -delete
          rm -f .qmake.stash

      - name: Verify test sources exist
        run: |
          echo "Checking Qt tests..."
          for d in tests/qt/test_*; do
            name=$(basename "$d")
            test -f "$d/$name.cpp" || { echo "Missing $d/$name.cpp"; exit 1; }
          done

          echo "Checking GoogleTest sources..."
          for pro in tests/gtest/*/*.pro; do
            dir=$(dirname "$pro")
            grep -o '[^ ]*\.cpp' "$pro" | while read src; do
              test -f "$dir/$src" || { echo "Missing $dir/$src"; exit 1; }
            done
          done

      - name: Configure project (with coverage)
        run: |
          qmake6 -r ClientServerSystem.pro \
            "QMAKE_CXXFLAGS+=--coverage -O0" \
            "QMAKE_LFLAGS+=--coverage"

      - name: Build project
        run: make -j$(nproc)

      - name: Run QtTests
        id: qttest
        run: |
          echo "Running Qt Tests..."
          QT_PASSED=0
          QT_FAILED=0
          
          for test in ./tests/qt/test_parser/test_parser \
                      ./tests/qt/test_append/test_append \
                      ./tests/qt/test_info/test_info \
                      ./tests/qt/test_cpu/test_cpu; do
            echo "Running $test..."
            OUTPUT=$("$test" 2>&1) || true
            echo "$OUTPUT"
            
            PASSED=$(echo "$OUTPUT" | grep -E '[0-9]+ passed' | grep -oE '[0-9]+' | head -1)
            FAILED=$(echo "$OUTPUT" | grep -E '[0-9]+ failed' | grep -oE '[0-9]+' | head -1)
            
            PASSED=${PASSED:-0}
            FAILED=${FAILED:-0}
            
            QT_PASSED=$((QT_PASSED + PASSED))
            QT_FAILED=$((QT_FAILED + FAILED))
          done
          
          echo "QT_PASSED=$QT_PASSED" >> "$GITHUB_ENV"
          echo "QT_FAILED=$QT_FAILED" >> "$GITHUB_ENV"
          echo "Qt Tests: $QT_PASSED passed, $QT_FAILED failed"

      - name: Run GoogleTests
        id: gtest
        run: |
          echo "Running GoogleTest..."
          OUTPUT=$(./tests/gtest/test_commands/test_commands 2>&1) || true
          echo "$OUTPUT"
          
          # Parse "[ PASSED ] X tests" line
          GTEST_PASSED=$(echo "$OUTPUT" | grep "PASSED" | grep -oE '[0-9]+' | tail -1)
          GTEST_FAILED=$(echo "$OUTPUT" | grep "FAILED" | grep -oE '[0-9]+' | tail -1)
          
          GTEST_PASSED=${GTEST_PASSED:-0}
          GTEST_FAILED=${GTEST_FAILED:-0}
          
          echo "GTEST_PASSED=$GTEST_PASSED" >> "$GITHUB_ENV"
          echo "GTEST_FAILED=$GTEST_FAILED" >> "$GITHUB_ENV"
          echo "GoogleTest: $GTEST_PASSED passed, $GTEST_FAILED failed"

      - name: Capture coverage data
        run: |
          lcov --capture \
               --directory . \
               --ignore-errors mismatch,empty \
               --rc geninfo_unexecuted_blocks=1 \
               --output-file coverage_raw.info

          lcov --remove coverage_raw.info \
               '/usr/*' \
               '*/tests/*' \
               --output-file coverage.info

          echo "=== LCOV Summary ==="
          lcov --summary coverage.info 2>&1 | tee lcov_summary.txt
          
          # Extract percentages using simple grep
          LINE_PERCENT=$(grep 'lines' lcov_summary.txt | grep -oE '[0-9]+\.[0-9]+' | head -1)
          FUNC_PERCENT=$(grep 'functions' lcov_summary.txt | grep -oE '[0-9]+\.[0-9]+' | head -1)
          
          # Extract counts
          LINE_INFO=$(grep 'lines' lcov_summary.txt)
          FUNC_INFO=$(grep 'functions' lcov_summary.txt)
          
          LINES_COVERED=$(echo "$LINE_INFO" | grep -oE '\([0-9]+' | tr -d '(')
          LINES_TOTAL=$(echo "$LINE_INFO" | grep -oE 'of [0-9]+' | grep -oE '[0-9]+')
          
          FUNCS_COVERED=$(echo "$FUNC_INFO" | grep -oE '\([0-9]+' | tr -d '(')
          FUNCS_TOTAL=$(echo "$FUNC_INFO" | grep -oE 'of [0-9]+' | grep -oE '[0-9]+')
          
          LINE_PERCENT=${LINE_PERCENT:-0}
          FUNC_PERCENT=${FUNC_PERCENT:-0}
          LINES_COVERED=${LINES_COVERED:-0}
          LINES_TOTAL=${LINES_TOTAL:-0}
          FUNCS_COVERED=${FUNCS_COVERED:-0}
          FUNCS_TOTAL=${FUNCS_TOTAL:-0}
          
          echo "LINE_PERCENT=$LINE_PERCENT" >> "$GITHUB_ENV"
          echo "FUNC_PERCENT=$FUNC_PERCENT" >> "$GITHUB_ENV"
          echo "LINES_COVERED=$LINES_COVERED" >> "$GITHUB_ENV"
          echo "LINES_TOTAL=$LINES_TOTAL" >> "$GITHUB_ENV"
          echo "FUNCS_COVERED=$FUNCS_COVERED" >> "$GITHUB_ENV"
          echo "FUNCS_TOTAL=$FUNCS_TOTAL" >> "$GITHUB_ENV"
          
          echo "Coverage: Line=${LINE_PERCENT}% Function=${FUNC_PERCENT}%"

      - name: Generate HTML coverage report
        run: |
          genhtml coverage.info \
            --output-directory coverage_html \
            --title "ClientServerSystem Coverage" \
            --legend

      - name: Generate unified HTML report
        shell: bash
        run: |
          LINE_PERCENT="${LINE_PERCENT:-0}"
          FUNC_PERCENT="${FUNC_PERCENT:-0}"
          LINES_COVERED="${LINES_COVERED:-0}"
          LINES_TOTAL="${LINES_TOTAL:-0}"
          FUNCS_COVERED="${FUNCS_COVERED:-0}"
          FUNCS_TOTAL="${FUNCS_TOTAL:-0}"
          QT_PASSED="${QT_PASSED:-0}"
          QT_FAILED="${QT_FAILED:-0}"
          GTEST_PASSED="${GTEST_PASSED:-0}"
          GTEST_FAILED="${GTEST_FAILED:-0}"
          
          TOTAL_PASSED=$((QT_PASSED + GTEST_PASSED))
          TOTAL_FAILED=$((QT_FAILED + GTEST_FAILED))
          NOT_COVERED=$(echo "scale=1; 100 - $LINE_PERCENT" | bc)
          
          CURRENT_DATE=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          
          echo "Final Report: Line=${LINE_PERCENT}% Func=${FUNC_PERCENT}% Tests=${TOTAL_PASSED}passed"

          cat > REPORT.html << EOF
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <title>ClientServerSystem - CI and Coverage Report</title>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <style>
              body { font-family: Arial, sans-serif; background:#f9f9f9; margin:40px; }
              h1, h2, h3 { color:#2c3e50; }
              .section { background:#fff; padding:20px; margin-bottom:25px; border-radius:6px; box-shadow:0 0 6px rgba(0,0,0,.1); }
              .grid { display:grid; grid-template-columns:1fr 1fr; gap:30px; }
              canvas { max-width:100%; height: 300px !important; }
              .footer { color:#777; font-size:.9em; margin-top: 30px; }
              .metrics { font-size: 1.1em; margin-bottom: 20px; }
              .metrics p { margin: 8px 0; }
              .metric-value { font-weight: bold; }
              .metric-good { color: #27ae60; }
              .summary-box { display: inline-block; padding: 15px 25px; margin: 10px; background: #ecf0f1; border-radius: 8px; text-align: center; }
              .summary-box .value { font-size: 2em; font-weight: bold; color: #2c3e50; }
              .summary-box .label { font-size: 0.9em; color: #7f8c8d; }
            </style>
          </head>
          <body>

          <h1>ClientServerSystem</h1>
          <h2>CI, Testing and Coverage Report</h2>

          <div class="section">
            <h3>Author</h3>
            <p><strong>Name:</strong> Mohamed Waaer</p>
            <p><strong>Email:</strong> mohamed.waer@coretech-innovations.com</p>
          </div>

          <div class="section">
            <h3>Summary</h3>
            <div style="text-align: center;">
              <div class="summary-box">
                <div class="value">${LINE_PERCENT}%</div>
                <div class="label">Line Coverage</div>
              </div>
              <div class="summary-box">
                <div class="value">${FUNC_PERCENT}%</div>
                <div class="label">Function Coverage</div>
              </div>
              <div class="summary-box">
                <div class="value">${TOTAL_PASSED}/${TOTAL_PASSED}</div>
                <div class="label">Tests Passed</div>
              </div>
            </div>
          </div>

          <div class="section">
            <h3>Test Coverage Metrics</h3>
            <div class="metrics">
              <p>Line Coverage: <span class="metric-value">${LINE_PERCENT}% (${LINES_COVERED} of ${LINES_TOTAL} lines)</span></p>
              <p>Function Coverage: <span class="metric-value">${FUNC_PERCENT}% (${FUNCS_COVERED} of ${FUNCS_TOTAL} functions)</span></p>
            </div>
            <div class="grid">
              <div><canvas id="coveragePie"></canvas></div>
              <div><canvas id="coverageBar"></canvas></div>
            </div>
          </div>

          <div class="section">
            <h3>Test Results</h3>
            <div class="metrics">
              <p>Qt Tests: <span class="metric-value metric-good">${QT_PASSED} passed, ${QT_FAILED} failed</span></p>
              <p>GoogleTest: <span class="metric-value metric-good">${GTEST_PASSED} passed, ${GTEST_FAILED} failed</span></p>
              <p>Total: <span class="metric-value">${TOTAL_PASSED} passed, ${TOTAL_FAILED} failed</span></p>
            </div>
            <div class="grid">
              <div><canvas id="testsPie"></canvas></div>
              <div><canvas id="testsBar"></canvas></div>
            </div>
          </div>

          <script>
            var linePercent = ${LINE_PERCENT};
            var funcPercent = ${FUNC_PERCENT};
            var notCovered = ${NOT_COVERED};
            var qtPassed = ${QT_PASSED};
            var qtFailed = ${QT_FAILED};
            var gtestPassed = ${GTEST_PASSED};
            var gtestFailed = ${GTEST_FAILED};
            var totalPassed = qtPassed + gtestPassed;
            var totalFailed = qtFailed + gtestFailed;

            new Chart(document.getElementById('coveragePie'), {
              type: 'pie',
              data: {
                labels: ['Covered (' + linePercent.toFixed(1) + '%)', 'Not Covered (' + notCovered.toFixed(1) + '%)'],
                datasets: [{ data: [linePercent, notCovered], backgroundColor: ['#4DD0E1', '#FF9F40'] }]
              },
              options: {
                responsive: true,
                plugins: { title: { display: true, text: 'Line Coverage Distribution' }, legend: { position: 'bottom' } }
              }
            });

            new Chart(document.getElementById('coverageBar'), {
              type: 'bar',
              data: {
                labels: ['Line Coverage', 'Function Coverage'],
                datasets: [{ label: 'Coverage (%)', data: [linePercent, funcPercent], backgroundColor: ['#4DD0E1', '#36A2EB'] }]
              },
              options: {
                responsive: true,
                plugins: { title: { display: true, text: 'Coverage by Type' }, legend: { display: false } },
                scales: { y: { beginAtZero: true, max: 100 } }
              }
            });

            new Chart(document.getElementById('testsPie'), {
              type: 'doughnut',
              data: {
                labels: ['Passed (' + totalPassed + ')', 'Failed (' + totalFailed + ')'],
                datasets: [{ data: [totalPassed, Math.max(totalFailed, 0.1)], backgroundColor: ['#4BC0C0', '#FF6384'] }]
              },
              options: {
                responsive: true,
                plugins: { title: { display: true, text: 'Test Results' }, legend: { position: 'bottom' } }
              }
            });

            new Chart(document.getElementById('testsBar'), {
              type: 'bar',
              data: {
                labels: ['Qt Tests', 'GoogleTest'],
                datasets: [
                  { label: 'Passed', data: [qtPassed, gtestPassed], backgroundColor: '#4BC0C0' },
                  { label: 'Failed', data: [qtFailed, gtestFailed], backgroundColor: '#FF6384' }
                ]
              },
              options: {
                responsive: true,
                plugins: { title: { display: true, text: 'Tests by Framework' } },
                scales: { y: { beginAtZero: true } }
              }
            });
          </script>

          <div class="footer">Generated by GitHub Actions CI on ${CURRENT_DATE}</div>

          </body>
          </html>
          EOF

          echo "Report generated!"

      - name: Create deliverable ZIP
        run: zip -r ClientServerSystem_Deliverable.zip REPORT.html coverage_html/

      - name: Upload deliverable
        uses: actions/upload-artifact@v4
        with:
          name: ClientServerSystem_Deliverable
          path: ClientServerSystem_Deliverable.zip