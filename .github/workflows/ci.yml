name: Qt6 CI

on:
  push:
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    # ‚úÖ Global environment for headless Qt
    env:
      QT_QPA_PLATFORM: offscreen
      QT_LOGGING_RULES: "qt.qpa.*=false"

    steps:
    # =========================
    # 1Ô∏è‚É£ Checkout repository
    # =========================
    - name: Checkout code
      uses: actions/checkout@v4

    # =========================
    # 2Ô∏è‚É£ Install dependencies
    # =========================
    - name: Install Qt 6 and build tools
      run: |
        sudo apt update
        sudo apt install -y \
          qt6-base-dev \
          qt6-tools-dev \
          qt6-tools-dev-tools \
          build-essential \
          cmake \
          libgtest-dev

    # =========================
    # 3Ô∏è‚É£ Build GoogleTest (Ubuntu ships sources only)
    # =========================
    - name: Build GoogleTest
      run: |
        cd /usr/src/gtest
        sudo cmake .
        sudo make -j$(nproc)
        sudo cp lib/*.a /usr/lib

    # =========================
    # 4Ô∏è‚É£ Clean build artifacts (reproducible builds)
    # =========================
    - name: Clean build artifacts
      run: |
        find . -name Makefile -delete
        find . -name "*.o" -delete
        find . -name "moc_*.cpp" -delete
        rm -f .qmake.stash

    # =========================
    # 5Ô∏è‚É£ Preflight check (FAIL FAST)
    # =========================
    - name: Verify test sources exist
      run: |
        echo "üîç Checking Qt tests..."
        for d in tests/qt/test_*; do
          name=$(basename "$d")
          if [ ! -f "$d/$name.cpp" ]; then
            echo "‚ùå Missing $d/$name.cpp"
            exit 1
          fi
        done

        echo "üîç Checking GoogleTest sources..."
        for pro in tests/gtest/*/*.pro; do
          dir=$(dirname "$pro")
          grep -o '[^ ]*\.cpp' "$pro" | while read src; do
            if [ ! -f "$dir/$src" ]; then
              echo "‚ùå Missing $dir/$src"
              exit 1
            fi
          done
        done

    # =========================
    # 6Ô∏è‚É£ Configure project (recursive qmake)
    # =========================
    - name: Configure project
      run: |
        qmake6 -r ClientServerSystem.pro

    # =========================
    # 7Ô∏è‚É£ Build project
    # =========================
    - name: Build project
      run: |
        make -j$(nproc)

    # =========================
    # 8Ô∏è‚É£ Verify build outputs
    # =========================
    - name: Verify build outputs
      run: |
        echo "üì¶ Server:"
        ls -l server || true
        echo "üì¶ Client:"
        ls -l client || true
        echo "üì¶ Qt tests:"
        find tests/qt -type f -executable
        echo "üì¶ GTest binaries:"
        find tests/gtest -type f -executable

    # =========================
    # 9Ô∏è‚É£ Run QtTests (headless)
    # =========================
    - name: Run QtTests
      run: |
        ./tests/qt/test_parser/test_parser
        ./tests/qt/test_append/test_append
        ./tests/qt/test_info/test_info
        ./tests/qt/test_cpu/test_cpu

    # =========================
    # üîü Run GoogleTests
    # =========================
    - name: Run GoogleTests
      run: |
        ./tests/gtest/test_commands/test_commands